# use images from rocker
FROM rocker/ml:4.3.2

# set user
USER root

# install ubuntu packages 
RUN apt-get update && \
    apt-get install -y \
    bash \
    patch \
    libmagick++-dev \
    libhdf5-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libpng-dev \
    libxt-dev \
    zlib1g-dev \
    libbz2-dev \
    liblzma-dev \
    libglpk40 \
    libgit2-dev \
    libgsl27 \
    libgsl-dev \
    cmake

# set default repository to CRAN
RUN echo 'options(repos = c(CRAN = "https://cloud.r-project.org"))' >>"${R_HOME}/etc/Rprofile.site"

# install R packages
RUN Rscript -e "install.packages(c('BiocManager', 'devtools', 'remotes'))"
RUN Rscript -e "BiocManager::install(version = '3.18')"
RUN Rscript -e "remotes::install_version('Matrix', version = '1.6.5')"
RUN Rscript -e "install.packages('Seurat')"
RUN Rscript -e "remotes::install_github('satijalab/azimuth', ref = 'master')"
RUN Rscript -e "remotes::install_github('satijalab/seurat-wrappers')"
RUN Rscript -e "remotes::install_github('massonix/SLOcatoR')"
RUN Rscript -e "remotes::install_github('morinlab/GAMBLR.data')"
RUN Rscript -e "remotes::install_github('cellgeni/sceasy')"
RUN Rscript -e "install.packages('magick')"
RUN Rscript -e "install.packages('harmony')"
RUN Rscript -e "install.packages('circlize')"
RUN Rscript -e "install.packages('rstatix')"
RUN Rscript -e "install.packages('fastTopics')"
RUN Rscript -e "install.packages('SoupX')"
RUN Rscript -e "install.packages('UpSetR')"
RUN Rscript -e "install.packages('ggalluvial')"
RUN Rscript -e "install.packages('ggbeeswarm')"
RUN Rscript -e "install.packages('languageserver')"
RUN Rscript -e "BiocManager::install('chromVAR')"
RUN Rscript -e "BiocManager::install('ComplexHeatmap')"
RUN Rscript -e "BiocManager::install('DESeq2')"
RUN Rscript -e "BiocManager::install('HCATonsilData')"
RUN Rscript -e "BiocManager::install('limma')"
RUN Rscript -e "BiocManager::install('biovizBase')"
RUN Rscript -e "BiocManager::install('edgeR')"
RUN Rscript -e "BiocManager::install('BiocSingular')"
RUN Rscript -e "BiocManager::install('scater')"
RUN Rscript -e "BiocManager::install('scDblFinder')"
RUN Rscript -e "BiocManager::install('batchelor')"
RUN apt-get install -y jags
RUN Rscript -e "BiocManager::install('infercnv')"
RUN Rscript -e "remotes::install_github('GreenleafLab/ArchR', ref='master', repos = BiocManager::repositories())"
RUN Rscript -e "library(ArchR)" -e "ArchR::installExtraPackages()"
RUN Rscript -e "remotes::install_github('GreenleafLab/chromVARmotifs')"
RUN Rscript -e "library(Seurat); library(infercnv); sessionInfo()"

# create venv
RUN apt-get install -y \
    python3 \
    python3-venv \
    python3-pip
RUN python3 -m venv /home/rstudio/venv
RUN chmod -R 755 /home/rstudio

# install python packages in venv
RUN /home/rstudio/venv/bin/pip3 install pandas
RUN /home/rstudio/venv/bin/pip3 install numpy
RUN /home/rstudio/venv/bin/pip3 install leidenalg
RUN /home/rstudio/venv/bin/pip3 install scanpy

# # install python packages globally
RUN pip install MACS2
RUN pip install numpy
RUN pip install Cython

# install scvi-tools in venv
RUN /home/rstudio/venv/bin/pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
RUN /home/rstudio/venv/bin/pip3 install jax==0.4.25
RUN /home/rstudio/venv/bin/pip3 install jaxlib==0.4.25
RUN /home/rstudio/venv/bin/pip3 install scvi-tools

# set environment variables
ENV VIRTUAL_ENV=/home/rstudio/venv